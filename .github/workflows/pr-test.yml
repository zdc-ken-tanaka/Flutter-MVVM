# =============================================================================
# PR Test Workflow - ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆè‡ªå‹•åˆ†æãƒ»ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ãƒ†ã‚¹ãƒˆ
# =============================================================================
# ç›®çš„: PRãƒˆãƒªã‚¬ãƒ¼ã§ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³+Mermaidå›³è¡¨ã‚’ãƒ†ã‚¹ãƒˆã—ã€Claude Codeçµ±åˆæº–å‚™
# å‹•ä½œ: PRä½œæˆæ™‚ã«è‡ªå‹•ã§ãƒªãƒƒãƒãªãƒ¬ãƒãƒ¼ãƒˆã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿

name: PR Test Workflow

# PRã‚¤ãƒ™ãƒ³ãƒˆãƒˆãƒªã‚¬ãƒ¼è¨­å®š
on:
  pull_request:
    types: [opened, synchronize, reopened]  # PRä½œæˆãƒ»æ›´æ–°ãƒ»å†ã‚ªãƒ¼ãƒ—ãƒ³æ™‚

jobs:
  pr-test:
    runs-on: ubuntu-latest
    
    # æ¨©é™è¨­å®šï¼ˆPRã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ã«å¿…è¦ï¼‰
    permissions:
      contents: read        # ãƒªãƒã‚¸ãƒˆãƒªå†…å®¹ã®èª­ã¿å–ã‚Š
      pull-requests: write  # PRã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿æ¨©é™
    
    steps:
      # =========================================================================
      # Step 1: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      # =========================================================================
      # ç›®çš„: PRå¤‰æ›´å†…å®¹ã‚’è§£æã™ã‚‹ãŸã‚ãƒªãƒã‚¸ãƒˆãƒªå…¨ä½“ã‚’runnerä¸Šã«å–å¾—
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å…¨å±¥æ­´å–å¾—ï¼ˆå·®åˆ†æ¯”è¼ƒã«å¿…è¦ï¼‰

      # =========================================================================
      # Step 2: PRåŸºæœ¬æƒ…å ±ã®è¡¨ç¤ºï¼ˆãƒ­ã‚°ç”¨ï¼‰
      # =========================================================================
      # ç›®çš„: ãƒ‡ãƒãƒƒã‚°ãƒ»ç¢ºèªç”¨ã«PRæƒ…å ±ã‚’Actionså®Ÿè¡Œãƒ­ã‚°ã«å‡ºåŠ›
      - name: Display PR Information
        run: |
          echo "ğŸ¯ PR Information"
          echo "PR Number: ${{ github.event.pull_request.number }}"
          echo "PR Title: ${{ github.event.pull_request.title }}"
          echo "PR Author: ${{ github.event.pull_request.user.login }}"
          echo "Base Branch: ${{ github.event.pull_request.base.ref }}"
          echo "Head Branch: ${{ github.event.pull_request.head.ref }}"

      # =========================================================================
      # Step 3: å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§è¡¨ç¤ºï¼ˆãƒ­ã‚°ç”¨ï¼‰
      # =========================================================================
      # ç›®çš„: ã©ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤‰æ›´ã•ã‚ŒãŸã‹ã‚’Actionså®Ÿè¡Œãƒ­ã‚°ã«å‡ºåŠ›
      - name: List Changed Files
        run: |
          echo "ğŸ“ Changed Files:"
          git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }}

      # =========================================================================
      # Step 4: å›ºå®šãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã‚³ãƒ¡ãƒ³ãƒˆç”Ÿæˆ
      # =========================================================================
      # ç›®çš„: ã‚·ãƒ³ãƒ—ãƒ«ãªãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ãƒ†ã‚¹ãƒˆï¼ˆYAMLæ§‹æ–‡ã‚¨ãƒ©ãƒ¼å›é¿ï¼‰
      - name: Create Simple Markdown Comment
        id: markdown
        run: |
          # ã‚¨ã‚³ãƒ¼ã‚’ä½¿ã£ã¦ç›´æ¥ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã‚’ä½œæˆï¼ˆãƒ’ã‚¢ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå›é¿ï¼‰
          echo "# ğŸš€ è‡ªå‹•PRåˆ†æãƒ¬ãƒãƒ¼ãƒˆ" > /tmp/comment.md
          echo "" >> /tmp/comment.md
          echo "## ğŸ“Š PRçµ±è¨ˆæƒ…å ±" >> /tmp/comment.md
          echo "" >> /tmp/comment.md
          echo "- **PRç•ªå·:** 123" >> /tmp/comment.md
          echo "- **ã‚¿ã‚¤ãƒˆãƒ«:** ãƒ†ã‚¹ãƒˆç”¨ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆ" >> /tmp/comment.md
          echo "- **ä½œæˆè€…:** test-user" >> /tmp/comment.md
          echo "- **å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«æ•°:** 5ãƒ•ã‚¡ã‚¤ãƒ«" >> /tmp/comment.md
          echo "" >> /tmp/comment.md
          echo "## ğŸ”„ PRãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼" >> /tmp/comment.md
          echo "" >> /tmp/comment.md
          echo '```mermaid' >> /tmp/comment.md
          echo 'graph TD' >> /tmp/comment.md
          echo '    A[é–‹ç™ºè€…] --> B[PRä½œæˆ]' >> /tmp/comment.md
          echo '    B --> C[GitHub Actions]' >> /tmp/comment.md
          echo '    C --> D[ã‚³ãƒ¼ãƒ‰åˆ†æ]' >> /tmp/comment.md
          echo '    D --> E[ãƒ¬ãƒ“ãƒ¥ãƒ¼]' >> /tmp/comment.md
          echo '    E --> F[ãƒãƒ¼ã‚¸]' >> /tmp/comment.md
          echo '```' >> /tmp/comment.md
          echo "" >> /tmp/comment.md
          echo "## ğŸ“ˆ ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³" >> /tmp/comment.md
          echo "" >> /tmp/comment.md
          echo '```mermaid' >> /tmp/comment.md
          echo 'sequenceDiagram' >> /tmp/comment.md
          echo '    participant A as é–‹ç™ºè€…' >> /tmp/comment.md
          echo '    participant B as GitHub' >> /tmp/comment.md
          echo '    A->>B: PRä½œæˆ' >> /tmp/comment.md
          echo '    B->>A: ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¾é ¼' >> /tmp/comment.md
          echo '    A->>B: ä¿®æ­£å¯¾å¿œ' >> /tmp/comment.md
          echo '    B->>A: ãƒãƒ¼ã‚¸å®Œäº†' >> /tmp/comment.md
          echo '```' >> /tmp/comment.md
          echo "" >> /tmp/comment.md
          echo "## âœ… ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ" >> /tmp/comment.md
          echo "" >> /tmp/comment.md
          echo "- [ ] ã‚³ãƒ¼ãƒ‰å“è³ªç¢ºèª" >> /tmp/comment.md
          echo "- [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯" >> /tmp/comment.md
          echo "- [ ] ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ" >> /tmp/comment.md
          echo "- [ ] ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°" >> /tmp/comment.md
          echo "" >> /tmp/comment.md
          echo "---" >> /tmp/comment.md
          echo "ğŸ¤– **è‡ªå‹•ç”Ÿæˆãƒ¬ãƒãƒ¼ãƒˆ**" >> /tmp/comment.md
          
          # ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹ã‚’GitHub Actionså‡ºåŠ›å¤‰æ•°ã«è¨­å®š
          echo "MARKDOWN_COMMENT<<EOF" >> $GITHUB_OUTPUT
          cat /tmp/comment.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # =========================================================================
      # Step 5: PRã¸ã®ã‚·ãƒ³ãƒ—ãƒ«ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿
      # =========================================================================
      # ç›®çš„: echoã§ä½œæˆã—ãŸãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã‚’PRã«ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿
      - name: Post Simple Markdown Comment
        uses: actions/github-script@v7  # GitHubAPIã‚’ç°¡å˜ã«ä½¿ãˆã‚‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}  # è‡ªå‹•æä¾›ã•ã‚Œã‚‹èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³
          script: |
            // å‰ã‚¹ãƒ†ãƒƒãƒ—ã§ç”Ÿæˆã—ãŸãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã‚³ãƒ¡ãƒ³ãƒˆã‚’å–å¾—
            const markdownComment = `${{ steps.markdown.outputs.MARKDOWN_COMMENT }}`;
            
            // GitHub REST APIã‚’ä½¿ã£ã¦PRã«ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿
            github.rest.issues.createComment({
              issue_number: context.issue.number,  // PRç•ªå·
              owner: context.repo.owner,           // ãƒªãƒã‚¸ãƒˆãƒªæ‰€æœ‰è€…
              repo: context.repo.repo,             // ãƒªãƒã‚¸ãƒˆãƒªå
              body: markdownComment                // ã‚³ãƒ¡ãƒ³ãƒˆæœ¬æ–‡
            });

      # =========================================================================
      # Step 6: å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
      # =========================================================================
      # ç›®çš„: ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Œäº†ã‚’ãƒ­ã‚°ã«è¨˜éŒ²
      - name: Test Complete
        run: |
          echo "âœ… PR Test Workflow completed successfully!"
          echo "ğŸ¨ Rich markdown comment with Mermaid diagrams posted!"
          echo "ğŸ‰ Ready for Claude Code integration!"