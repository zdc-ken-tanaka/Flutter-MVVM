# =============================================================================
# PR Test Workflow - ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆè‡ªå‹•åˆ†æãƒ»ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ãƒ†ã‚¹ãƒˆ
# =============================================================================
# ç›®çš„: PRãƒˆãƒªã‚¬ãƒ¼ã§ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³+Mermaidå›³è¡¨ã‚’ãƒ†ã‚¹ãƒˆã—ã€Claude Codeçµ±åˆæº–å‚™
# å‹•ä½œ: PRä½œæˆæ™‚ã«è‡ªå‹•ã§ãƒªãƒƒãƒãªãƒ¬ãƒãƒ¼ãƒˆã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿

name: PR Test Workflow

# PRã‚¤ãƒ™ãƒ³ãƒˆãƒˆãƒªã‚¬ãƒ¼è¨­å®š
on:
  pull_request:
    types: [opened, synchronize, reopened]  # PRä½œæˆãƒ»æ›´æ–°ãƒ»å†ã‚ªãƒ¼ãƒ—ãƒ³æ™‚

jobs:
  pr-test:
    runs-on: ubuntu-latest
    
    # æ¨©é™è¨­å®šï¼ˆPRã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ã«å¿…è¦ï¼‰
    permissions:
      contents: read        # ãƒªãƒã‚¸ãƒˆãƒªå†…å®¹ã®èª­ã¿å–ã‚Š
      pull-requests: write  # PRã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿æ¨©é™
    
    steps:
      # =========================================================================
      # Step 1: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      # =========================================================================
      # ç›®çš„: PRå¤‰æ›´å†…å®¹ã‚’è§£æã™ã‚‹ãŸã‚ãƒªãƒã‚¸ãƒˆãƒªå…¨ä½“ã‚’runnerä¸Šã«å–å¾—
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å…¨å±¥æ­´å–å¾—ï¼ˆå·®åˆ†æ¯”è¼ƒã«å¿…è¦ï¼‰

      # =========================================================================
      # Step 2: PRåŸºæœ¬æƒ…å ±ã®è¡¨ç¤ºï¼ˆãƒ­ã‚°ç”¨ï¼‰
      # =========================================================================
      # ç›®çš„: ãƒ‡ãƒãƒƒã‚°ãƒ»ç¢ºèªç”¨ã«PRæƒ…å ±ã‚’Actionså®Ÿè¡Œãƒ­ã‚°ã«å‡ºåŠ›
      - name: Display PR Information
        run: |
          echo "ğŸ¯ PR Information"
          echo "PR Number: ${{ github.event.pull_request.number }}"
          echo "PR Title: ${{ github.event.pull_request.title }}"
          echo "PR Author: ${{ github.event.pull_request.user.login }}"
          echo "Base Branch: ${{ github.event.pull_request.base.ref }}"
          echo "Head Branch: ${{ github.event.pull_request.head.ref }}"

      # =========================================================================
      # Step 3: å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§è¡¨ç¤ºï¼ˆãƒ­ã‚°ç”¨ï¼‰
      # =========================================================================
      # ç›®çš„: ã©ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤‰æ›´ã•ã‚ŒãŸã‹ã‚’Actionså®Ÿè¡Œãƒ­ã‚°ã«å‡ºåŠ›
      - name: List Changed Files
        run: |
          echo "ğŸ“ Changed Files:"
          git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }}

      # =========================================================================
      # Step 4: ãƒªãƒƒãƒãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã‚³ãƒ¡ãƒ³ãƒˆç”Ÿæˆ
      # =========================================================================
      # ç›®çš„: Mermaidå›³è¡¨ã‚’å«ã‚€è±ªè¯ãªPRãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆï¼ˆClaude Codeçµ±åˆãƒ†ã‚¹ãƒˆï¼‰
      - name: Create Rich Markdown Comment
        id: markdown  # å¾Œç¶šã‚¹ãƒ†ãƒƒãƒ—ã§å‚ç…§ã™ã‚‹ãŸã‚ã®ID
        run: |
          # PRçµ±è¨ˆæƒ…å ±ã‚’å–å¾—
          CHANGED_FILES_COUNT=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} | wc -l)
          ADDITIONS=${{ github.event.pull_request.additions }}
          DELETIONS=${{ github.event.pull_request.deletions }}
          
          # ãƒ’ã‚¢ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå½¢å¼ã§ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ãƒ¬ãƒãƒ¼ãƒˆä½œæˆ
          # æ³¨æ„: EOFã‚’ã‚¯ã‚©ãƒ¼ãƒˆã§å›²ã‚€ã“ã¨ã§å¤‰æ•°å±•é–‹ã‚’ç„¡åŠ¹åŒ–
          COMMENT_BODY=$(cat << 'EOF'
# ğŸš€ è‡ªå‹•PRåˆ†æãƒ¬ãƒãƒ¼ãƒˆ

## ğŸ“Š PRçµ±è¨ˆæƒ…å ±

| é …ç›® | å€¤ |
|------|-----|
| **PRç•ªå·** | #${{ github.event.pull_request.number }} |
| **ã‚¿ã‚¤ãƒˆãƒ«** | ${{ github.event.pull_request.title }} |
| **ä½œæˆè€…** | @${{ github.event.pull_request.user.login }} |
| **å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«æ•°** | CHANGED_FILES_COUNT_PLACEHOLDER |
| **è¿½åŠ è¡Œæ•°** | +ADDITIONS_PLACEHOLDER |
| **å‰Šé™¤è¡Œæ•°** | -DELETIONS_PLACEHOLDER |

## ğŸ”„ PRãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ•ãƒ­ãƒ¼

```mermaid
graph TD
    A[ğŸ‘¨â€ğŸ’» é–‹ç™ºè€…ãŒã‚³ãƒ¼ãƒ‰å¤‰æ›´] --> B[ğŸ“ PRä½œæˆ]
    B --> C{ğŸ¤– GitHub Actions}
    C --> D[ğŸ“‹ ã‚³ãƒ¼ãƒ‰åˆ†æ]
    C --> E[ğŸ§ª ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ]
    C --> F[ğŸ“Š ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ]
    D --> G[âœ… ãƒ¬ãƒ“ãƒ¥ãƒ¼æº–å‚™å®Œäº†]
    E --> G
    F --> G
    G --> H[ğŸ‘¥ äººé–“ãƒ¬ãƒ“ãƒ¥ãƒ¼]
    H --> I{æ‰¿èª?}
    I -->|Yes| J[ğŸ‰ ãƒãƒ¼ã‚¸]
    I -->|No| K[ğŸ”„ ä¿®æ­£]
    K --> A
    
    style A fill:#e1f5fe
    style G fill:#e8f5e8
    style J fill:#c8e6c9
    style K fill:#ffecb3
```

## ğŸ“ˆ ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ—ãƒ­ã‚»ã‚¹

```mermaid
sequenceDiagram
    participant Dev as ğŸ‘¨â€ğŸ’» é–‹ç™ºè€…
    participant GitHub as ğŸ“š GitHub
    participant Actions as ğŸ¤– Actions
    participant Reviewer as ğŸ‘¥ ãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼
    
    Dev->>GitHub: 1. PRä½œæˆ
    GitHub->>Actions: 2. ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼èµ·å‹•
    Actions->>Actions: 3. ã‚³ãƒ¼ãƒ‰åˆ†æå®Ÿè¡Œ
    Actions->>GitHub: 4. åˆ†æçµæœæŠ•ç¨¿
    GitHub->>Reviewer: 5. ãƒ¬ãƒ“ãƒ¥ãƒ¼é€šçŸ¥
    Reviewer->>GitHub: 6. ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼
    alt æ‰¿èªã®å ´åˆ
        Reviewer->>GitHub: 7a. æ‰¿èª
        GitHub->>GitHub: 8a. ãƒãƒ¼ã‚¸
    else ä¿®æ­£è¦æ±‚ã®å ´åˆ
        Reviewer->>Dev: 7b. ä¿®æ­£ä¾é ¼
        Dev->>GitHub: 8b. è¿½åŠ ã‚³ãƒŸãƒƒãƒˆ
        GitHub->>Actions: 9b. å†åˆ†æ
    end
```

## ğŸ” å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«è©³ç´°

**å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§:**
```
CHANGED_FILES_LIST_PLACEHOLDER
```

## ğŸ“ æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

### âœ… ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦³ç‚¹
- [ ] **ã‚³ãƒ¼ãƒ‰å“è³ª**: å¯èª­æ€§ãƒ»ä¿å®ˆæ€§ã®ç¢ºèª
- [ ] **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: è„†å¼±æ€§ã®æœ‰ç„¡ã‚’ãƒã‚§ãƒƒã‚¯
- [ ] **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**: å‡¦ç†åŠ¹ç‡ã®æ¤œè¨¼
- [ ] **ãƒ†ã‚¹ãƒˆ**: é©åˆ‡ãªãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸
- [ ] **ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**: å¿…è¦ã«å¿œã˜ã¦æ›´æ–°

### ğŸ¯ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
1. **ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Ÿæ–½**
2. **ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯åæ˜ **
3. **æœ€çµ‚ç¢ºèªãƒ»æ‰¿èª**
4. **ãƒãƒ¼ã‚¸å®Ÿè¡Œ**

## ğŸ“š é–¢é€£ãƒªãƒ³ã‚¯

- ğŸ“– [ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¦ç´„](https://example.com/coding-standards)
- ğŸ§ª [ãƒ†ã‚¹ãƒˆã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³](https://example.com/testing-guide)  
- ğŸ”’ [ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ](https://example.com/security-checklist)

---
ğŸ¤– **è‡ªå‹•ç”Ÿæˆãƒ¬ãƒãƒ¼ãƒˆ** | â° ç”Ÿæˆæ™‚åˆ»: $(date '+%Y-%m-%d %H:%M:%S UTC') | ğŸ”— [ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼è©³ç´°](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
EOF
)
          
          # ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’å®Ÿéš›ã®å€¤ã«ç½®æ›ï¼ˆsedä½¿ç”¨ï¼‰
          COMMENT_BODY=$(echo "$COMMENT_BODY" | sed "s/CHANGED_FILES_COUNT_PLACEHOLDER/$CHANGED_FILES_COUNT/g")
          COMMENT_BODY=$(echo "$COMMENT_BODY" | sed "s/ADDITIONS_PLACEHOLDER/$ADDITIONS/g")
          COMMENT_BODY=$(echo "$COMMENT_BODY" | sed "s/DELETIONS_PLACEHOLDER/$DELETIONS/g")
          
          # å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’å–å¾—ã—ã¦ãƒªã‚¹ãƒˆå½¢å¼ã«å¤‰æ›
          CHANGED_FILES_LIST=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} | sed 's/^/- /')
          COMMENT_BODY=$(echo "$COMMENT_BODY" | sed "s|CHANGED_FILES_LIST_PLACEHOLDER|$CHANGED_FILES_LIST|g")
          
          # GitHub Actionså‡ºåŠ›å¤‰æ•°ã«è¨­å®šï¼ˆè¤‡æ•°è¡Œå¯¾å¿œï¼‰
          echo "MARKDOWN_COMMENT<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMENT_BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # =========================================================================
      # Step 5: PRã¸ã®ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿
      # =========================================================================
      # ç›®çš„: ç”Ÿæˆã—ãŸãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ãƒ¬ãƒãƒ¼ãƒˆã‚’å®Ÿéš›ã®PRã«ã‚³ãƒ¡ãƒ³ãƒˆã¨ã—ã¦æŠ•ç¨¿
      - name: Post Rich Markdown Comment
        uses: actions/github-script@v7  # GitHubAPIã‚’ç°¡å˜ã«ä½¿ãˆã‚‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}  # è‡ªå‹•æä¾›ã•ã‚Œã‚‹èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³
          script: |
            // å‰ã‚¹ãƒ†ãƒƒãƒ—ã§ç”Ÿæˆã—ãŸãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã‚³ãƒ¡ãƒ³ãƒˆã‚’å–å¾—
            const markdownComment = `${{ steps.markdown.outputs.MARKDOWN_COMMENT }}`;
            
            // GitHub REST APIã‚’ä½¿ã£ã¦PRã«ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿
            github.rest.issues.createComment({
              issue_number: context.issue.number,  // PRç•ªå·
              owner: context.repo.owner,           // ãƒªãƒã‚¸ãƒˆãƒªæ‰€æœ‰è€…
              repo: context.repo.repo,             // ãƒªãƒã‚¸ãƒˆãƒªå
              body: markdownComment                // ã‚³ãƒ¡ãƒ³ãƒˆæœ¬æ–‡
            });

      # =========================================================================
      # Step 6: å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
      # =========================================================================
      # ç›®çš„: ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Œäº†ã‚’ãƒ­ã‚°ã«è¨˜éŒ²
      - name: Test Complete
        run: |
          echo "âœ… PR Test Workflow completed successfully!"
          echo "ğŸ¨ Rich markdown comment with Mermaid diagrams posted!"
          echo "ğŸ‰ Ready for Claude Code integration!"