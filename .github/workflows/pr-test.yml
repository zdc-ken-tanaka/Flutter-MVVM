name: PR Test Workflow

# PRトリガー設定
on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  pr-test:
    runs-on: ubuntu-latest
    
    steps:
      # 1. リポジトリをチェックアウト
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 全履歴取得（差分比較用）

      # 2. PR情報を表示
      - name: Display PR Information
        run: |
          echo "🎯 PR Information"
          echo "PR Number: ${{ github.event.pull_request.number }}"
          echo "PR Title: ${{ github.event.pull_request.title }}"
          echo "PR Author: ${{ github.event.pull_request.user.login }}"
          echo "Base Branch: ${{ github.event.pull_request.base.ref }}"
          echo "Head Branch: ${{ github.event.pull_request.head.ref }}"
          echo "Changed Files Count: ${{ github.event.pull_request.changed_files }}"

      # 3. 変更されたファイルを一覧表示
      - name: List Changed Files
        run: |
          echo "📁 Changed Files:"
          git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }}

      # 4. 簡単なコード分析（例：ファイル数カウント）
      - name: Basic Code Analysis
        run: |
          echo "📊 Basic Analysis:"
          echo "Total files: $(find . -type f -name '*.py' -o -name '*.js' -o -name '*.md' | wc -l)"
          echo "Python files: $(find . -name '*.py' | wc -l)"
          echo "JavaScript files: $(find . -name '*.js' | wc -l)"
          echo "Markdown files: $(find . -name '*.md' | wc -l)"

      # 5. PR変更サマリーを作成
      - name: Create PR Summary
        id: summary
        run: |
          SUMMARY="## 🔍 PR Analysis Summary
          
          **PR #${{ github.event.pull_request.number }}**: ${{ github.event.pull_request.title }}
          
          ### 📊 Statistics
          - **Changed Files**: ${{ github.event.pull_request.changed_files }}
          - **Additions**: +${{ github.event.pull_request.additions }}
          - **Deletions**: -${{ github.event.pull_request.deletions }}
          
          ### 📝 Changed Files List
          \`\`\`
          $(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }})
          \`\`\`
          
          ---
          *Auto-generated by GitHub Actions* ⚡"
          
          # 複数行文字列をGitHub Actions環境変数にセット
          echo "SUMMARY<<EOF" >> $GITHUB_OUTPUT
          echo "$SUMMARY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # 6. PRにコメントを投稿（権限があれば）
      # - name: Comment on PR
      #   uses: actions/github-script@v7
      #   with:
      #     github-token: ${{ secrets.GITHUB_TOKEN }}
      #     script: |
      #       const summary = `${{ steps.summary.outputs.SUMMARY }}`;
            
      #       github.rest.issues.createComment({
      #         issue_number: context.issue.number,
      #         owner: context.repo.owner,
      #         repo: context.repo.repo,
      #         body: summary
      #       });

      # 7. 成功メッセージ
      - name: Test Complete
        run: |
          echo "✅ PR Test Workflow completed successfully!"
          echo "🎉 Ready for Claude Code integration!"